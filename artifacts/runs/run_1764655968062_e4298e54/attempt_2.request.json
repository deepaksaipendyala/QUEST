{
  "repo": "django/django",
  "version": "4.1",
  "code_file": "django/views/static.py",
  "test_src": "import tempfile\nimport unittest\nfrom unittest.mock import Mock\nfrom django.http import Http404, HttpResponseNotModified, FileResponse\nfrom django.views.static import serve, directory_index, was_modified_since\nfrom pathlib import Path\nimport time\n\n\nclass StaticFileServeTests(unittest.TestCase):\n\n    def setUp(self):\n        self.temp_dir = tempfile.TemporaryDirectory()\n        self.document_root = Path(self.temp_dir.name)\n        self.file_path = self.document_root / \"test_file.txt\"\n        self.file_path.write_text(\"This is a test file.\")\n        self.directory_path = self.document_root / \"test_dir\"\n        self.directory_path.mkdir()\n        self.directory_index_template = self.document_root / \"static/directory_index.html\"\n        self.directory_index_template.parent.mkdir(parents=True, exist_ok=True)\n        self.directory_index_template.write_text(\"<html><body>Index of {{ directory }}</body></html>\")\n\n    def tearDown(self):\n        self.temp_dir.cleanup()\n\n    def test_serve_valid_file(self):\n        request = Mock(META={})\n        response = serve(request, \"test_file.txt\", document_root=self.document_root)\n        self.assertIsInstance(response, FileResponse)\n        self.assertEqual(response.status_code, 200)\n        self.assertEqual(response['Content-Type'], 'text/plain')\n        self.assertIn(\"Last-Modified\", response.headers)\n        self.assertEqual(response['Content-Length'], str(len(\"This is a test file.\")))\n        self.assertEqual(response.content, b\"This is a test file.\")\n\n    def test_serve_missing_file(self):\n        request = Mock(META={})\n        with self.assertRaises(Http404):\n            serve(request, \"missing_file.txt\", document_root=self.document_root)\n\n    def test_serve_directory_with_show_indexes(self):\n        request = Mock(META={})\n        response = serve(request, \"test_dir\", document_root=self.document_root, show_indexes=True)\n        self.assertEqual(response.status_code, 200)\n        self.assertIn(b'Index of', response.content)\n        self.assertIn(b'test_dir', response.content)\n\n    def test_serve_directory_without_show_indexes(self):\n        request = Mock(META={})\n        with self.assertRaises(Http404):\n            serve(request, \"test_dir\", document_root=self.document_root, show_indexes=False)\n\n    def test_serve_file_with_if_modified_since(self):\n        request = Mock(META={\"HTTP_IF_MODIFIED_SINCE\": time.strftime(\"%a, %d %b %Y %H:%M:%S GMT\", time.gmtime())})\n        response = serve(request, \"test_file.txt\", document_root=self.document_root)\n        self.assertIsInstance(response, HttpResponseNotModified)\n\n    def test_directory_index(self):\n        response = directory_index(\"test_dir\", self.directory_path)\n        self.assertEqual(response.status_code, 200)\n        self.assertIn(b'Index of test_dir', response.content)\n        self.assertIn(b'test_file.txt', response.content)\n\n    def test_was_modified_since_true(self):\n        header = time.strftime(\"%a, %d %b %Y %H:%M:%S GMT\", time.gmtime(time.time() - 100))\n        self.assertTrue(was_modified_since(header, time.time(), self.file_path.stat().st_size))\n\n    def test_was_modified_since_false(self):\n        header = time.strftime(\"%a, %d %b %Y %H:%M:%S GMT\", time.gmtime(time.time() + 100))\n        self.assertFalse(was_modified_since(header, time.time(), self.file_path.stat().st_size))\n\n    def test_was_modified_since_invalid_header(self):\n        self.assertTrue(was_modified_since(\"invalid_header\", 0, 0))\n\n    def test_was_modified_since_no_header(self):\n        self.assertTrue(was_modified_since(None, 0, 0))\n\n    def test_serve_file_with_empty_if_modified_since(self):\n        request = Mock(META={\"HTTP_IF_MODIFIED_SINCE\": \"\"})\n        response = serve(request, \"test_file.txt\", document_root=self.document_root)\n        self.assertIsInstance(response, FileResponse)\n\n    def test_serve_directory_with_no_files(self):\n        empty_dir = self.document_root / \"empty_dir\"\n        empty_dir.mkdir()\n        request = Mock(META={})\n        response = serve(request, \"empty_dir\", document_root=self.document_root, show_indexes=True)\n        self.assertEqual(response.status_code, 200)\n        self.assertIn(b'Index of empty_dir', response.content)\n        self.assertIn(b'No files found', response.content)\n\n    def test_serve_file_with_invalid_path(self):\n        request = Mock(META={})\n        with self.assertRaises(Http404):\n            serve(request, \"../test_file.txt\", document_root=self.document_root)\n\n    def test_directory_index_with_no_template(self):\n        response = directory_index(\"test_dir\", self.directory_path)\n        self.assertEqual(response.status_code, 200)\n        self.assertIn(b'Index of test_dir', response.content)\n        self.assertNotIn(b'Index of {{ directory }}', response.content)\n\n    def test_serve_file_with_non_ascii_characters(self):\n        non_ascii_file = self.document_root / \"test_file_\u00f1.txt\"\n        non_ascii_file.write_text(\"This file has non-ASCII character.\")\n        request = Mock(META={})\n        response = serve(request, \"test_file_\u00f1.txt\", document_root=self.document_root)\n        self.assertIsInstance(response, FileResponse)\n        self.assertEqual(response.status_code, 200)\n        self.assertEqual(response.content, b\"This file has non-ASCII character.\")\n\n    def test_serve_directory_with_special_characters(self):\n        special_dir = self.document_root / \"test dir @#\"\n        special_dir.mkdir()\n        request = Mock(META={})\n        response = serve(request, \"test dir @#\", document_root=self.document_root, show_indexes=True)\n        self.assertEqual(response.status_code, 200)\n        self.assertIn(b'Index of test dir @#', response.content)\n\n    def test_serve_file_with_large_size(self):\n        large_file = self.document_root / \"large_file.txt\"\n        large_file.write_text(\"A\" * (10**6))  # 1 MB file\n        request = Mock(META={})\n        response = serve(request, \"large_file.txt\", document_root=self.document_root)\n        self.assertIsInstance(response, FileResponse)\n        self.assertEqual(response.status_code, 200)\n        self.assertEqual(response['Content-Length'], str(10**6))\n\n    def test_serve_file_with_invalid_method(self):\n        request = Mock(META={}, method='POST')\n        with self.assertRaises(Http404):\n            serve(request, \"test_file.txt\", document_root=self.document_root)\n\n    def test_directory_index_with_multiple_files(self):\n        self.file_path.write_text(\"Another test file.\")\n        response = directory_index(\"test_dir\", self.directory_path)\n        self.assertEqual(response.status_code, 200)\n        self.assertIn(b'Index of test_dir', response.content)\n        self.assertIn(b'test_file.txt', response.content)\n        self.assertIn(b'Another test file.', response.content)"
}